# Stationarity: ADF tests

# ADF test on log prices -- RESULTS IN NON-STATIONARITY
adf.test(log_prices$Gasoline)
adf.test(log_prices$HO)

# ADF test on returns -- RESULTS IN STATIONARITY
adf.test(returns$Gasoline)
adf.test(returns$HO)

"""
ADF on prices → p-value > 0.05 → cannot reject unit root → non-stationary
ADF on returns → p-value < 0.05 → reject unit root → stationary

Next: We want to check the relationship longer-term variables. Since there are only two variables, we are using the Engle-Granger analysis.

The Engle-Granger two-step method involves:
1. Regressing one non-stationary variable on another to obtain residuals.
2. Testing the residuals for stationarity using the ADF test.

The regression estimates β, the long-run equilibrium ratio between the two stocks
"""

p1 <- as.numeric(log_prices$HO)
p2 <- as.numeric(log_prices$Gasoline)

eg_model <- lm(p1 ~ p2)
summary(eg_model)

beta <- eg_model$coefficients[2]

# Residuals = spread candidate
spread <- eg_model$residuals
spread_xts <- xts(spread, order.by = index(log_prices))

adf.test(spread)

"""

calculating my z score (~how unlikely is the point obersved from the mean given the volativity) will tell me if the spread is abnorammly high or low.

If the spread is high, RBOB is overpriced vs HO.
If the spread is low, RBOB is cheap vs HO.
"""


# Remove NAs just to be safe
spread_clean <- na.omit(spread_xts)

z <- (spread_clean - spread_mean) / spread_sd

# AR(1) model: s_t = mu + phi * s_{t-1} + error
ar1_model <- arima(spread_clean, order = c(1, 0, 0))
ar1_model

phi <- ar1_model$coef["ar1"]

# Half-life of mean reversion
half_life <- -log(2) / log(abs(phi))
half_life

# ENGLE-GRANGER RESULTS TABLE

library(tseries)

# Calculate all necessary values
p1 <- as.numeric(log_prices$HO)
p2 <- as.numeric(log_prices$Gasoline)

eg_model <- lm(p1 ~ p2)
spread <- eg_model$residuals
adf_spread <- adf.test(spread)

# Create the results table
eg_results_table <- data.frame(
  Parameter = c("Intercept", 
                "Slope (β)", 
                "R²", 
                "Adj. R²",
                "ADF Statistic (Spread)", 
                "ADF P-Value"),
  Value = c(
    round(eg_model$coefficients[1], 4),
    round(eg_model$coefficients[2], 4),
    round(summary(eg_model)$r.squared, 4),
    round(summary(eg_model)$adj.r.squared, 4),
    round(adf_spread$statistic, 4),
    round(adf_spread$p.value, digits = 2)
  ),
  Interpretation = c(
    "Base price difference between HO and RBOB",
    "Hedge ratio: HO change per 1% RBOB change",
    "Proportion of variance explained",
    "Adjusted R² for number of predictors",
    "Test for spread stationarity",
    ifelse(adf_spread$p.value < 0.05, 
           "Significant cointegration (p < 0.05)", 
           "No cointegration detected")
  ),
  stringsAsFactors = FALSE
)

# Save as RDS file
saveRDS(eg_results_table, "data_analysis/eg_results_table.rds")

# save individual values 
eg_values <- list(
  intercept = eg_model$coefficients[1],
  beta = eg_model$coefficients[2],
  r_squared = summary(eg_model)$r.squared,
  adj_r_squared = summary(eg_model)$adj.r.squared,
  adf_statistic = adf_spread$statistic,
  adf_pvalue = adf_spread$p.value,
  cointegrated = adf_spread$p.value < 0.05
)

saveRDS(eg_values, "data_analysis/eg_values.rds")
